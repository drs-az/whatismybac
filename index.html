<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="theme-color" content="#2e2a2a" />
<title>Bar Buddy ‚Äî BAC Estimator (Stable)</title>
<style>
  :root{ --bg:#0b0b0c; --panel:#171518; --ink:#f3f3f3; --muted:#bdbdbd; --bar:#2b2320; --bar-edge:#3d302b; --accent:#ffd26b; --danger:#ff6b6b; }
  *{box-sizing:border-box} html,body{height:100%}
  body{ margin:0; background:radial-gradient(1200px 1200px at 50% -240px,#1a1a1f 0,#0b0b0c 65%); color:var(--ink);
        font:500 16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; display:flex; align-items:center; justify-content:center; padding:18px; }
  .app{ width:min(980px,100%); background:var(--panel); border:1px solid #26242a; border-radius:22px; padding:18px; box-shadow:0 30px 80px rgba(0,0,0,.45); position:relative; overflow:hidden; }
  header{display:flex; align-items:center; justify-content:space-between; gap:12px}
  h1{margin:0; font-size:22px} .muted{color:var(--muted)}
  .grid{display:grid; gap:12px; grid-template-columns:1fr} @media (min-width:780px){ .grid{grid-template-columns:1fr 1fr} }
  .scene{position:relative; min-height:280px; border-radius:16px; background:linear-gradient(#1a191c, #121113 52%, #0f0e10 52%); border:1px solid #26242a}
  .bar{ position:absolute; left:0; right:0; bottom:0; height:46%; background:linear-gradient(#3a2f29, #2b2320);
        border-top:3px solid var(--bar-edge); box-shadow: inset 0 12px 18px rgba(0,0,0,.35); }
  .drinks{ position:absolute; inset:12px 12px auto 12px; display:flex; gap:10px; flex-wrap:wrap; }
  button.drink{ background:#1b1a1f; border:1px solid #2c2a32; color:#fff; padding:10px 12px; border-radius:12px; cursor:pointer; display:flex; gap:8px; align-items:center; font-weight:600; }
  button.drink:hover{border-color:#3a3844}
  .controls{display:flex; gap:10px; flex-wrap:wrap}
  .card{background:#0f0e12; border:1px solid #25242b; border-radius:16px; padding:12px}
  .row{display:flex; align-items:center; justify-content:space-between}
  .big{font-size:30px; font-weight:800} .danger{color:var(--danger)}
  label small{color:#aaa}
  input, select{background:#141318; color:#fff; border:1px solid #2b2a31; padding:10px 12px; border-radius:10px; width:100%;}
  .two{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .toast{position:fixed; left:50%; bottom:22px; transform:translateX(-50%); background:#121317; color:#e7ffe7; border:1px solid #2b2c34;
    padding:10px 14px; border-radius:12px; box-shadow:0 12px 30px rgba(0,0,0,.4); display:none; z-index:10}
  .toast.show{display:block; animation:fade .25s ease-out}
  @keyframes fade{from{opacity:0; transform:translate(-50%,6px)} to{opacity:1; transform:translate(-50%,0)}}
  footer{margin-top:10px; color:#a1a1a7; font-size:12px}
  .btn{background:#1b1a1f; color:#fff; border:1px solid #2c2a32; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:700}
  .btn:hover{border-color:#3a3a46}
  .pill{padding:6px 10px; border-radius:999px; border:1px solid #323038; font-size:12px}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  .fun-emoji{position:absolute; animation:pop 1s ease-out forwards; font-size:32px; pointer-events:none}
  @keyframes pop{from{transform:translateY(0) scale(1);opacity:1}to{transform:translateY(-40px) scale(1.4);opacity:0}}
</style>
</head>
<body>
<div class="app">
  <header>
    <h1>Bar Buddy</h1>
    <div class="muted pill">Tap drinks as you go ‚Äî real-time BAC estimate</div>
  </header>

  <div class="grid">
    <section class="scene">
      <div class="drinks">
        <button class="drink" data-std="1" data-name="Beer">üç∫ Beer</button>
        <button class="drink" data-std="1" data-name="Wine">üç∑ Wine</button>
        <button class="drink" data-std="1" data-name="Shot">ü•É Shot</button>
        <button class="drink" data-std="1.25" data-name="Cocktail">üç∏ Cocktail</button>
        <button class="drink" data-std="0.5" data-name="Seltzer">ü•Ç Seltzer (1/2)</button>
      </div>
      <div class="bar"></div>
    </section>

    <section class="card">
      <div class="two">
        <label>Weight
          <small>(toggle units)</small>
          <div class="two">
            <input id="weight" type="number" inputmode="decimal" min="30" value="180" />
            <select id="units">
              <option value="lb" selected>lb</option>
              <option value="kg">kg</option>
            </select>
          </div>
        </label>
        <label>Sex at birth
          <select id="sex">
            <option value="m" selected>Male (r‚âà0.68)</option>
            <option value="f">Female (r‚âà0.55)</option>
            <option value="c">Custom</option>
          </select>
        </label>
      </div>
      <div id="rWrap" class="two" style="margin-top:8px; display:none">
        <label>Widmark r
          <input id="rval" type="number" step="0.01" min="0.45" max="0.9" value="0.68" />
        </label>
        <label>Elimination Œ≤ (per hr)
          <input id="beta" type="number" step="0.001" min="0.010" max="0.030" value="0.015" />
        </label>
      </div>

      <div class="row" style="margin-top:8px">
        <div>Session</div><div id="sessionState" class="pill">Not started</div>
      </div>
      <div class="row"><div>Session time</div><div id="sessionClock" class="mono">0:00:00</div></div>

      <div class="controls" style="margin:10px 0 6px">
        <button id="startBtn" class="btn">Start session</button>
        <button id="endBtn" class="btn" disabled>End session</button>
        <button id="shareBtn" class="btn" disabled>Share badge</button>
      </div>

      <hr style="border:0;border-top:1px solid #2b2a31;margin:10px 0">

      <div class="row"><div>Current BAC</div><div class="big" id="bac">0.000</div></div>
      <div class="row"><div>Peak so far</div><div id="peak">0.000</div></div>
      <div class="row"><div>Since first drink</div><div id="elapsed">0:00</div></div>
      <div class="row"><div>ETA &lt; 0.05</div><div id="eta50">‚Äî</div></div>
      <div class="row"><div>ETA 0.00</div><div id="eta00">‚Äî</div></div>
      <div style="margin-top:10px" class="muted">
        Educational estimate uses Widmark formula with US standard drinks (0.6 fl oz ethanol per drink) and weight in pounds.
        <span class="danger"><b>Never drive after drinking.</b></span>
      </div>

    </section>
  </div>

  <footer>US standard drink = 14 g = 0.6 fl oz ethanol. Widmark: BAC = (A * 5.14 / (W_lb * r)) ‚àí Œ≤¬∑hours; Œ≤ default 0.015 %BAC/hr.</footer>
  <div id="toast" class="toast"></div>
</div>

<script>
const $ = (s) => document.querySelector(s);
const els = {
  weight: $('#weight'), units: $('#units'), sex: $('#sex'), rWrap: $('#rWrap'),
  rval: $('#rval'), beta: $('#beta'),
  startBtn: $('#startBtn'), endBtn: $('#endBtn'), shareBtn: $('#shareBtn'), scene: $('.scene'),
  sessionState: $('#sessionState'), sessionClock: $('#sessionClock'),
  bac: $('#bac'), peak: $('#peak'), elapsed: $('#elapsed'), eta50: $('#eta50'), eta00: $('#eta00'),
  toast: $('#toast')
};
const DRINKS = []; const STD_FL_OZ = 0.6;
let session = {started:false, t0:null, tick:null, clockTick:null, peak:0};

function toast(msg){ els.toast.textContent = msg; els.toast.classList.add('show'); setTimeout(()=>els.toast.classList.remove('show'),1800); }
function lbs(){ const v = parseFloat(els.weight.value||0); return (els.units.value==='kg') ? v*2.20462 : v; }
function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
function rConst(){ if(els.sex.value==='m') return 0.68; if(els.sex.value==='f') return 0.55; return clamp(parseFloat(els.rval.value||0.68), 0.45, 0.9); }
function beta(){ return clamp(parseFloat(els.beta.value||0.015), 0.010, 0.030); }
function fmtH(ms){ const s=Math.max(0,Math.floor(ms/1000)); const h=Math.floor(s/3600); const m=Math.floor((s%3600)/60); const ss=String(s%60).padStart(2,'0'); return `${h}:${String(m).padStart(2,'0')}:${ss}`; }
function fmtHM(ms){ if(ms<=0) return '0:00'; const m=Math.round(ms/60000); const h=Math.floor(m/60); const mm=String(m%60).padStart(2,'0'); return `${h}:${mm}`; }
function fmtEta(hrs){ if(!isFinite(hrs)||hrs<=0) return 'Now'; const ms=hrs*3600000, when=new Date(Date.now()+ms); return `${fmtHM(ms)} (‚âà ${when.toLocaleTimeString([], {hour:'numeric', minute:'2-digit'})})`; }

function storePrefs(){ localStorage.setItem('bb_prefs', JSON.stringify({ w: els.weight.value, u: els.units.value, s: els.sex.value, r: els.rval.value, b: els.beta.value })); }
function restorePrefs(){ try{ const j=JSON.parse(localStorage.getItem('bb_prefs')||'{}'); if(j.w) els.weight.value=j.w; if(j.u) els.units.value=j.u; if(j.s) els.sex.value=j.s; if(j.r) els.rval.value=j.r; if(j.b) els.beta.value=j.b; els.rWrap.style.display=(els.sex.value==='c')?'grid':'none'; }catch{} }
function saveSession(){ localStorage.setItem('bb_session', JSON.stringify({ started: session.started, t0: session.t0, peak: session.peak, drinks: DRINKS })); }
function restoreSession(){ try{ const j=JSON.parse(localStorage.getItem('bb_session')||'{}'); if(j && j.started){ session.started = true; session.t0 = j.t0; session.peak = j.peak||0; DRINKS.splice(0, DRINKS.length, ...(j.drinks||[])); els.sessionState.textContent = 'Running'; els.endBtn.disabled=false; els.startBtn.disabled=true; startClock(); startRecalc(); } }catch{} }

function bacNow(){
  if(DRINKS.length===0) return 0;
  const now = Date.now();
  const W = Math.max(80, lbs());
  const r = rConst();
  const bRate = beta();
  let total = 0;
  for(const d of DRINKS){
    const A = d.std * STD_FL_OZ;
    const hrs = (now - d.t)/3600000;
    const contrib = (A * 5.14 / (W * r)) - bRate*hrs;
    if(contrib>0) total += contrib;
  }
  return total;
}
function activeContribs(){
  const now = Date.now();
  const W = Math.max(80, lbs());
  const r = rConst();
  const bRate = beta();
  const arr=[];
  for(const d of DRINKS){
    const A = d.std * STD_FL_OZ;
    const hrs = (now - d.t)/3600000;
    const contrib = (A * 5.14 / (W * r)) - bRate*hrs;
    if(contrib>0) arr.push({b:contrib,t:d.t,rem:contrib/bRate});
  }
  return arr;
}
function etaFrom(contribs, target){
  const bRate = beta();
  if(contribs.length===0) return 0;
  const arr=[...contribs].sort((a,b)=>a.rem-b.rem);
  let total = arr.reduce((s,d)=>s+d.b,0);
  let prev = 0;
  let active = arr.length;
  for(const c of arr){
    const dt = c.rem - prev;
    if(total - bRate*active*dt <= target){
      const needed = total - target;
      return prev + needed/(bRate*active);
    }
    total -= bRate*active*dt;
    prev = c.rem;
    active--;
  }
  return prev;
}
function recalc(){
  const contribs = activeContribs();
  const b = contribs.reduce((s,d)=>s+d.b,0);
  session.peak=Math.max(session.peak||0,b);
  els.bac.textContent=b.toFixed(3);
  els.peak.textContent=session.peak.toFixed(3);
  const earliest = contribs.length?Math.min(...contribs.map(d=>d.t)):null;
  els.elapsed.textContent=earliest?fmtHM(Date.now()-earliest):'0:00';
  els.eta50.textContent=b<=0.05?'Now':fmtEta(etaFrom(contribs,0.05));
  els.eta00.textContent=b<=0?'Now':fmtEta(etaFrom(contribs,0));
}

function startClock(){
  stopClock();
  function update(){
    if(!session.started || !session.t0){
      els.sessionClock.textContent='0:00:00';
      return;
    }
    els.sessionClock.textContent = fmtH(Date.now()-session.t0);
  }
  update();
  session.clockTick = setInterval(update, 1000);
}
function stopClock(){ if(session.clockTick) clearInterval(session.clockTick); session.clockTick=null; }
function startRecalc(){ if(session.tick) clearInterval(session.tick); session.tick = setInterval(recalc, 1000); }
function stopRecalc(){ if(session.tick) clearInterval(session.tick); session.tick=null; }

document.querySelectorAll('button.drink').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    if(!session.started){ toast('Start session first'); return; }
    const std=parseFloat(btn.dataset.std), name=btn.dataset.name;
    DRINKS.push({name, std, t: Date.now()});
    saveSession(); recalc();
    toast(`+ ${name} (${std.toFixed(2)} std)`);
    const emoji=document.createElement('div');
    emoji.className='fun-emoji';
    emoji.textContent=['üçª','ü•Ç','üçπ','üéâ'][Math.floor(Math.random()*4)];
    const r=btn.getBoundingClientRect(), s=els.scene.getBoundingClientRect();
    emoji.style.left=(r.left - s.left + r.width/2)+'px';
    emoji.style.top=(r.top - s.top)+'px';
    els.scene.appendChild(emoji);
    setTimeout(()=>emoji.remove(),1000);
  });
});
els.startBtn.addEventListener('click', ()=>{ if(session.started) return; session.started=true; session.t0=Date.now(); session.peak=0; DRINKS.length=0; els.sessionState.textContent='Running'; els.endBtn.disabled=false; els.shareBtn.disabled=true; els.startBtn.disabled=true; saveSession(); startClock(); startRecalc(); recalc(); });
els.endBtn.addEventListener('click', async ()=>{
  if(!session.started) return;
  stopClock(); stopRecalc(); session.started=false;
  els.sessionState.textContent='Ended';
  els.endBtn.disabled=true; els.startBtn.disabled=false; els.shareBtn.disabled=false;
  saveSession(); recalc();
  try{ const png=await buildBadgePNG(); await tryShareBadge(png); }catch{}
});
els.shareBtn.addEventListener('click', async ()=>{
  try{ recalc(); const png=await buildBadgePNG(); await tryShareBadge(png); }catch{}
});
els.sex.addEventListener('change', ()=>{ els.rWrap.style.display=(els.sex.value==='c')?'grid':'none'; storePrefs(); recalc(); });
[els.weight, els.units, els.rval, els.beta].forEach(i=> i.addEventListener('input', ()=>{ storePrefs(); recalc(); }));

restorePrefs(); restoreSession(); recalc();

async function buildBadgePNG(){
  const w=1200, h=630, pad=48;
  const c=document.createElement('canvas'); c.width=w; c.height=h; const ctx=c.getContext('2d');
  const g=ctx.createLinearGradient(0,0,0,h); g.addColorStop(0,'#1a1719'); g.addColorStop(1,'#0b0a0c'); ctx.fillStyle=g; ctx.fillRect(0,0,w,h);
  const X=pad, Y=pad, W=w-pad*2, H=h-pad*2;
  roundRect(ctx,X,Y,W,H,26); ctx.fillStyle='#121115'; ctx.fill(); ctx.strokeStyle='#25242b'; ctx.lineWidth=2; ctx.stroke();
  ctx.fillStyle='#f3f3f3'; ctx.font='700 54px system-ui, Segoe UI, Roboto'; ctx.fillText('Bar Buddy ‚Äî Session Badge', X+24, Y+70);
  const barY=Y+110, barH=H-210;
  ctx.fillStyle='#3a2f29'; roundRect(ctx, X+28, barY+barH-120, W-56, 92, 14); ctx.fill();
  ctx.strokeStyle='#4a3a34'; ctx.lineWidth=3; roundRect(ctx, X+28, barY+barH-120, W-56, 92, 14); ctx.stroke();
  let idx=0, row=0;
  const drawers={'Beer':drawEmptyBeer,'Wine':drawEmptyWine,'Shot':drawEmptyShot,'Cocktail':drawEmptyMartini,'Seltzer':drawEmptyWine};
  const cellW=(W-56-20)/Math.max(1,Math.min(DRINKS.length||1,10));
  for(const d of DRINKS){ const col=idx%10; row=Math.floor(idx/10); const cx=X+38+col*cellW+cellW/2; const cy=barY+barH-140-row*120; (drawers[d.name]||drawEmptyShot)(ctx,cx,cy,60); idx++; if(row>=2) break; }
  const contribs=activeContribs();
  const b=contribs.reduce((s,d)=>s+d.b,0); const peak=session.peak||0;
  ctx.fillStyle='#ffd26b'; ctx.font='600 34px system-ui, Segoe UI, Roboto';
  const eta50=b<=0.05?'Now':timeIn(etaFrom(contribs,0.05)); const eta00=b<=0?'Now':timeIn(etaFrom(contribs,0));
  let y=Y+H-70; ctx.fillText(`Drinks: ${DRINKS.length}`, X+34, y); y-=42; ctx.fillText(`Peak BAC: ${peak.toFixed(3)} | Current: ${b.toFixed(3)}`, X+34, y); y-=42; ctx.fillText(`Est. time until < 0.05: ${eta50}`, X+34, y); y-=42; ctx.fillText(`Est. time until 0.00: ${eta00}`, X+34, y);
  const blob=await new Promise(res=>c.toBlob(res,'image/png')); if(blob) return blob;
  const dataURL=c.toDataURL('image/png'); const bstr=atob(dataURL.split(',')[1]); let n=bstr.length; const u8=new Uint8Array(n); while(n--) u8[n]=bstr.charCodeAt(n); return new Blob([u8], {type:'image/png'});
  function timeIn(hrs){ const ms=hrs*3600000; const when=new Date(Date.now()+ms); return `${fmtHM(ms)} (‚âà ${when.toLocaleTimeString([], {hour:'numeric',minute:'2-digit'})})`; }
}
function roundRect(ctx,x,y,w,h,r){ctx.beginPath();ctx.moveTo(x+r,y);ctx.arcTo(x+w,y,x+w,y+h,r);ctx.arcTo(x+w,y+h,x,y+h,r);ctx.arcTo(x,y+h,x,y,r);ctx.arcTo(x,y,x+w,y,r);ctx.closePath();}
function drawEmptyBeer(ctx, cx, cy, s){ctx.save();ctx.translate(cx,cy);ctx.strokeStyle='#c8c0b8';ctx.lineWidth=3;ctx.lineJoin='round';ctx.fillStyle='rgba(200,192,184,0.08)';ctx.beginPath();ctx.moveTo(-s*0.28,-s*0.6);ctx.lineTo(-s*0.28,s*0.4);ctx.lineTo(s*0.28,s*0.4);ctx.lineTo(s*0.28,-s*0.6);ctx.closePath();ctx.fill();ctx.stroke();ctx.beginPath();ctx.arc(s*0.4,-s*0.1,s*0.22,-Math.PI/2,Math.PI/2);ctx.stroke();ctx.restore();}
function drawEmptyWine(ctx, cx, cy, s){ctx.save();ctx.translate(cx,cy);ctx.strokeStyle='#c8c0b8';ctx.lineWidth=3;ctx.fillStyle='rgba(200,192,184,0.08)';ctx.beginPath();ctx.ellipse(0,-s*0.15,s*0.26,s*0.33,0,0,Math.PI*2);ctx.fill();ctx.stroke();ctx.beginPath();ctx.moveTo(0,s*0.15);ctx.lineTo(0,s*0.42);ctx.moveTo(-s*0.22,s*0.42);ctx.lineTo(s*0.22,s*0.42);ctx.stroke();ctx.restore();}
function drawEmptyShot(ctx, cx, cy, s){ctx.save();ctx.translate(cx,cy);ctx.strokeStyle='#c8c0b8';ctx.lineWidth=3;ctx.fillStyle='rgba(200,192,184,0.08)';ctx.beginPath();ctx.moveTo(-s*0.2,-s*0.45);ctx.lineTo(-s*0.28,s*0.35);ctx.lineTo(s*0.28,s*0.35);ctx.lineTo(s*0.2,-s*0.45);ctx.closePath();ctx.fill();ctx.stroke();ctx.restore();}
function drawEmptyMartini(ctx, cx, cy, s){ctx.save();ctx.translate(cx,cy);ctx.strokeStyle='#c8c0b8';ctx.lineWidth=3;ctx.fillStyle='rgba(200,192,184,0.08)';ctx.beginPath();ctx.moveTo(-s*0.45,-s*0.4);ctx.lineTo(0,s*0.05);ctx.lineTo(s*0.45,-s*0.4);ctx.lineTo(-s*0.45,-s*0.4);ctx.fill();ctx.stroke();ctx.beginPath();ctx.moveTo(0,s*0.05);ctx.lineTo(0,s*0.45);ctx.moveTo(-s*0.18,s*0.45);ctx.lineTo(s*0.18,s*0.45);ctx.stroke();ctx.restore();}

async function tryShareBadge(pngBlob){
  const file = new File([pngBlob], 'bar-buddy-badge.png', {type:'image/png'});
  if(navigator.canShare && navigator.canShare({files:[file]})){
    await navigator.share({title:'Bar Buddy ‚Äî Session Badge', text:'My Bar Buddy session (educational estimate only).', files:[file]}).catch(()=>{});
  }else{
    const a=document.createElement('a'); a.href=URL.createObjectURL(pngBlob); a.download='bar-buddy-badge.png'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 1500); toast('Badge downloaded.');
  }
}
</script>
<script>
// Add install button and PWA plumbing
let deferredPrompt=null;
const installBtn=document.createElement('button'); installBtn.textContent='Install'; installBtn.className='btn'; installBtn.style.position='fixed'; installBtn.style.right='16px'; installBtn.style.bottom='16px'; installBtn.style.zIndex='20'; installBtn.hidden=true; document.body.appendChild(installBtn);
window.addEventListener('beforeinstallprompt',(e)=>{e.preventDefault(); deferredPrompt=e; installBtn.hidden=false;});
installBtn.addEventListener('click', async ()=>{ if(!deferredPrompt) return; installBtn.hidden=true; deferredPrompt.prompt(); try{await deferredPrompt.userChoice;}catch{} deferredPrompt=null; });

(async function injectManifestAndIcons(){
  const icon192=await drawIcon(192), icon512=await drawIcon(512);
  const manifest={name:"Bar Buddy ‚Äî BAC Estimator", short_name:"Bar Buddy", start_url:"./", display:"standalone", background_color:"#0b0b0c", theme_color:"#2e2a2a",
    icons:[{src:icon192,sizes:"192x192",type:"image/png",purpose:"any maskable"},{src:icon512,sizes:"512x512",type:"image/png",purpose:"any maskable"}]};
  const blob=new Blob([JSON.stringify(manifest)],{type:'application/manifest+json'});
  const link=document.createElement('link'); link.rel='manifest'; link.href=URL.createObjectURL(blob); document.head.appendChild(link);
  const touch=document.createElement('link'); touch.rel='apple-touch-icon'; touch.href=icon192; document.head.appendChild(touch);
})();
function drawIcon(size){ const c=document.createElement('canvas'); c.width=c.height=size; const ctx=c.getContext('2d'); ctx.fillStyle='#2b2320'; ctx.fillRect(0,0,size,size); ctx.fillStyle='#ffd26b'; ctx.font=`${Math.floor(size*0.6)}px serif`; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText('üç∏', size/2, size/2+size*0.05); return c.toDataURL('image/png'); }

(function registerSW(){ if(!('serviceWorker' in navigator)) return; const swCode=`
  const CACHE='barbuddy-v4';
  const ASSETS=['./','./index.html'];
  self.addEventListener('install',e=>{e.waitUntil(caches.open(CACHE).then(c=>c.addAll(ASSETS))); self.skipWaiting();});
  self.addEventListener('activate',e=>{e.waitUntil(caches.keys().then(keys=>Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k))))); self.clients.claim();});
  self.addEventListener('fetch',e=>{e.respondWith(fetch(e.request).catch(()=>caches.match(e.request).then(r=>r||caches.match('./'))));});
`; const url=URL.createObjectURL(new Blob([swCode],{type:'text/javascript'})); navigator.serviceWorker.register(url).catch(()=>{}); })();
</script>
</body>
</html>
