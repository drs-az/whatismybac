<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="theme-color" content="#18181d" />
<link rel="manifest" href="manifest.json" />
<link rel="icon" href="iconbb.png" />
<title>Bar Buddy ‚Äî BAC Estimator (Stable)</title>
<style>
  :root{ --bg:#0d0d10; --panel:#18181d; --ink:#f5f5f7; --muted:#a5a5aa; --accent:#ffb347; --danger:#ff6b6b; }
  *{box-sizing:border-box} html,body{height:100%}
  body{ margin:0; background:radial-gradient(1000px 1000px at 50% -200px,#27262b 0,var(--bg) 70%); color:var(--ink);
        font:400 16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; display:flex; justify-content:center; align-items:flex-start; min-height:100vh; padding:24px; }
  .app{ width:min(960px,100%); background:var(--panel); border:1px solid #2e2d33; border-radius:24px; padding:24px; box-shadow:0 24px 64px rgba(0,0,0,.55); position:relative; overflow:hidden; }
  header{display:flex; align-items:center; justify-content:space-between; gap:12px}
  h1{margin:0; font-size:24px; font-weight:700} .muted{color:var(--muted)}
  .grid{display:grid; gap:16px; grid-template-columns:1fr} @media (min-width:780px){ .grid{grid-template-columns:1fr 1fr} }
  .scene{position:relative; min-height:280px; border-radius:20px; background:linear-gradient(#1d1c20, #141316 55%, #121215 55%); border:1px solid #2e2d33; padding:16px; display:flex; flex-direction:column; gap:16px}
  .drinks{ display:grid; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); gap:12px; }
  .drink-log{ font-size:32px; line-height:1; min-height:40px; min-width:0; width:100%; }
  button.drink{ background:#1e1e24; border:1px solid #34333b; color:var(--ink); padding:10px 14px; border-radius:14px; cursor:pointer; display:flex; gap:8px; align-items:center; font-weight:600; }
  button.drink:hover{border-color:#484751; background:#26262d}
  .controls{display:grid; gap:12px; grid-template-columns:repeat(2,1fr)}
  .controls .btn{width:100%}
  .modal{position:fixed; inset:0; background:rgba(0,0,0,.85); display:flex; align-items:center; justify-content:center; z-index:100}
  .modal.hide{display:none}
  .modal-content{background:var(--panel); padding:24px; border-radius:20px; text-align:center; max-width:90%; width:360px}
  .modal-content img{max-width:100px; margin-bottom:16px}
  .modal-content h2{margin-top:0}
  .modal-content .btn{width:100%}
  .card{background:#141319; border:1px solid #2e2d33; border-radius:20px; padding:16px}
  .row{display:flex; align-items:center; justify-content:space-between}
  .big{font-size:32px; font-weight:800} .danger{color:var(--danger)}
  label small{color:#888}
  input, select{background:#19181d; color:#fff; border:1px solid #33323a; padding:10px 12px; border-radius:12px; width:100%;}
  .two{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  .toast{position:fixed; left:50%; bottom:22px; transform:translateX(-50%); background:#18181d; color:#e7ffe7; border:1px solid #2b2c34;
    padding:10px 14px; border-radius:12px; box-shadow:0 12px 30px rgba(0,0,0,.4); display:none; z-index:10}
  .toast.show{display:block; animation:fade .25s ease-out}
  @keyframes fade{from{opacity:0; transform:translate(-50%,6px)} to{opacity:1; transform:translate(-50%,0)}}
  footer{margin-top:10px; color:#a1a1a7; font-size:12px}
  .btn{background:var(--accent); color:#000; border:none; padding:10px 18px; border-radius:14px; cursor:pointer; font-weight:700; transition:filter .15s}
  .btn:hover{filter:brightness(1.1)}
  .pill{padding:6px 10px; border-radius:999px; border:1px solid #323038; font-size:12px}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  .fun-emoji{position:absolute; animation:pop 1s ease-out forwards; font-size:32px; pointer-events:none}
  @keyframes pop{from{transform:translateY(0) scale(1);opacity:1}to{transform:translateY(-40px) scale(1.4);opacity:0}}
</style>
</head>
<body>
<div class="app">
  <header>
    <img src="iconbb.png" alt="Bar Buddy" style="height:75px" />
    <div class="muted pill">Tap drinks as you go ‚Äî real-time BAC estimate</div>
  </header>
<br>
  <div class="grid">
      <section class="scene">
        <div class="drinks">
          <button class="drink" data-std="1" data-name="Beer">üç∫ Beer (12&nbsp;oz)</button>
          <button class="drink" data-std="1.33" data-name="Pint">üç∫ Pint (16&nbsp;oz)</button>
          <button class="drink" data-std="1" data-name="Wine">üç∑ Wine</button>
          <button class="drink" data-std="1" data-name="Shot">ü•É Shot</button>
          <button class="drink" data-std="1.33" data-name="Cocktail">üç∏ Cocktail</button>
          <button class="drink" data-std="1" data-name="Seltzer">ü•Ç Hard Seltzer</button>
        </div>
          <div id="drinkLog" class="drink-log"></div>
      </section>
      <section class="card">
      <div class="two">
        <label>Weight
          <small>(toggle units)</small>
          <div class="two">
            <input id="weight" type="number" inputmode="decimal" min="30" value="180" />
            <select id="units">
              <option value="lb" selected>lb</option>
              <option value="kg">kg</option>
            </select>
          </div>
        </label>
        <label>Sex at birth
          <select id="sex">
            <option value="m" selected>Male (r‚âà0.68)</option>
            <option value="f">Female (r‚âà0.55)</option>
            <option value="c">Custom</option>
          </select>
        </label>
      </div>
      <div id="rWrap" class="two" style="margin-top:8px; display:none">
        <label>Widmark r
          <input id="rval" type="number" step="0.01" min="0.45" max="0.9" value="0.68" />
        </label>
        <label>Elimination Œ≤ (per hr)
          <input id="beta" type="number" step="0.001" min="0.010" max="0.030" value="0.015" />
        </label>
      </div>

      <div class="row" style="margin-top:8px">
        <div>Session</div><div id="sessionState" class="pill">Not started</div>
      </div>
      <div class="row"><div>Session time</div><div id="sessionClock" class="mono">0:00:00</div></div>

        <div class="controls" style="margin:10px 0 6px">
          <button id="startBtn" class="btn">Start session</button>
          <button id="endBtn" class="btn" disabled>End session</button>
          <button id="shareBtn" class="btn">Share Bar Buddy</button>
          <button id="uberBtn" class="btn">Call Uber</button>
        </div>

      <hr style="border:0;border-top:1px solid #2b2a31;margin:10px 0">

      <div class="row"><div>Current BAC</div><div class="big" id="bac">0.000</div></div>
      <div class="row"><div>Peak so far</div><div id="peak">0.000</div></div>
      <div class="row"><div>Std drinks</div><div id="stdDrinks">0.00</div></div>
      <div class="row"><div>Since first drink</div><div id="elapsed">0:00</div></div>
      <div class="row"><div>ETA &lt; 0.05</div><div id="eta50">‚Äî</div></div>
      <div class="row"><div>ETA 0.00</div><div id="eta00">‚Äî</div></div>
      <div style="margin-top:10px" class="muted">
        Educational estimate uses Widmark formula with US standard drinks (0.6 fl oz ethanol per drink) and weight in pounds.
        <span class="danger"><b>Never drive after drinking.</b></span>
      </div>

    </section>
  </div>

  <footer>US standard drink = 14 g = 0.6 fl oz ethanol. Widmark: BAC = (A * 5.14 / (W_lb * r)) ‚àí Œ≤¬∑hours; Œ≤ default 0.015 %BAC/hr.</footer>
  <div id="toast" class="toast"></div>
</div>

<div id="welcomeModal" class="modal hide">
  <div class="modal-content">
    <img src="iconbb.png" alt="Bar Buddy logo" />
    <h2>Welcome to Bar Buddy</h2>
    <p>Track your drinks and estimate your BAC in real time. Please drink responsibly.</p>
    <button id="installBtn" class="btn" disabled>Install</button>
  </div>
</div>

<div id="shareModal" class="modal hide" tabindex="-1">
  <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="shareTitle">
    <h2 id="shareTitle">Share Bar Buddy</h2>
    <input id="shareUrl" class="mono" readonly>
    <button id="copyLinkBtn" class="btn" style="margin-top:8px">Copy link</button>
    <canvas id="qrCanvas" aria-label="App QR code" width="180" height="180" style="margin-top:16px"></canvas>
    <button id="closeShare" class="btn" style="margin-top:16px">Close</button>
  </div>
</div>

<script>
const $ = (s) => document.querySelector(s);
const els = {
  weight: $('#weight'), units: $('#units'), sex: $('#sex'), rWrap: $('#rWrap'),
  rval: $('#rval'), beta: $('#beta'),
    startBtn: $('#startBtn'), endBtn: $('#endBtn'), shareBtn: $('#shareBtn'), uberBtn: $('#uberBtn'), scene: $('.scene'), drinkLog: $('#drinkLog'),
  sessionState: $('#sessionState'), sessionClock: $('#sessionClock'),
    bac: $('#bac'), peak: $('#peak'), stdDrinks: $('#stdDrinks'), elapsed: $('#elapsed'), eta50: $('#eta50'), eta00: $('#eta00'),
    drinkLog: $('#drinkLog'),
  toast: $('#toast'),
  shareModal: $('#shareModal'), shareUrl: $('#shareUrl'), copyLinkBtn: $('#copyLinkBtn'), qrCanvas: $('#qrCanvas'), closeShare: $('#closeShare')
};
const DRINKS = []; const STD_FL_OZ = 0.6; const ICONS={Beer:'üç∫', Pint:'üç∫', Wine:'üç∑', Shot:'ü•É', Cocktail:'üç∏', Seltzer:'ü•Ç'};
function renderLog(){ els.drinkLog.innerHTML=''; for(const d of DRINKS){ const span=document.createElement('span'); span.textContent=ICONS[d.name]||'üçπ'; els.drinkLog.appendChild(span);} }
let session = {started:false, t0:null, tick:null, clockTick:null, peak:0};

function toast(msg){ els.toast.textContent = msg; els.toast.classList.add('show'); setTimeout(()=>els.toast.classList.remove('show'),1800); }
function lbs(){ const v = parseFloat(els.weight.value||0); return (els.units.value==='kg') ? v*2.20462 : v; }
function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
function rConst(){ if(els.sex.value==='m') return 0.68; if(els.sex.value==='f') return 0.55; return clamp(parseFloat(els.rval.value||0.68), 0.45, 0.9); }
function beta(){ return clamp(parseFloat(els.beta.value||0.015), 0.010, 0.030); }
function fmtH(ms){ const s=Math.max(0,Math.floor(ms/1000)); const h=Math.floor(s/3600); const m=Math.floor((s%3600)/60); const ss=String(s%60).padStart(2,'0'); return `${h}:${String(m).padStart(2,'0')}:${ss}`; }
function fmtHM(ms){ if(ms<=0) return '0:00'; const m=Math.round(ms/60000); const h=Math.floor(m/60); const mm=String(m%60).padStart(2,'0'); return `${h}:${mm}`; }
function fmtEta(hrs){ if(!isFinite(hrs)||hrs<=0) return 'Now'; const ms=hrs*3600000, when=new Date(Date.now()+ms); return `${fmtHM(ms)} (‚âà ${when.toLocaleTimeString([], {hour:'numeric', minute:'2-digit'})})`; }

function renderDrinkLog(){
  els.drinkLog.textContent = DRINKS.map(d=>d.icon).join(' ');
}

function storePrefs(){ localStorage.setItem('bb_prefs', JSON.stringify({ w: els.weight.value, u: els.units.value, s: els.sex.value, r: els.rval.value, b: els.beta.value })); }
function restorePrefs(){ try{ const j=JSON.parse(localStorage.getItem('bb_prefs')||'{}'); if(j.w) els.weight.value=j.w; if(j.u) els.units.value=j.u; if(j.s) els.sex.value=j.s; if(j.r) els.rval.value=j.r; if(j.b) els.beta.value=j.b; els.rWrap.style.display=(els.sex.value==='c')?'grid':'none'; }catch{} }
function saveSession(){ localStorage.setItem('bb_session', JSON.stringify({ started: session.started, t0: session.t0, peak: session.peak, drinks: DRINKS })); }
function restoreSession(){
  try{
    const j=JSON.parse(localStorage.getItem('bb_session')||'{}');
    if(j && j.started){
      session.started = true;
      session.t0 = j.t0;
      session.peak = j.peak||0;
      DRINKS.splice(0, DRINKS.length, ...(j.drinks||[]));
      renderDrinkLog();
      els.sessionState.textContent = 'Running';
      els.endBtn.disabled=false;
      els.startBtn.disabled=true;
      startClock(); startRecalc();
    }
  }catch{}
  els.shareBtn.disabled=session.started;
}
async function shareApp(){
  const url=window.location.href;
  if(navigator.share){
    try{ await navigator.share({title:'Bar Buddy', url}); }catch{}
  }else{
    els.shareUrl.value=url;
    try{ await generateQR(url); }catch{}
    els.shareModal.classList.remove('hide');
    els.shareUrl.focus();
  }
}
async function generateQR(text){
  if(!els.qrCanvas) return;
  if(!window.QRCode){
    await new Promise((res,rej)=>{ const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js'; s.onload=res; s.onerror=rej; document.head.appendChild(s); });
  }
  return new Promise((res,rej)=>{ window.QRCode.toCanvas(els.qrCanvas, text, {width:180}, e=> e?rej(e):res()); });
}
function bacNow(){
  if(DRINKS.length===0) return 0;
  const now = Date.now();
  const W = Math.max(80, lbs());
  const r = rConst();
  const bRate = beta();
  let total = 0;
  for(const d of DRINKS){
    const A = d.std * STD_FL_OZ;
    const hrs = (now - d.t)/3600000;
    const contrib = (A * 5.14 / (W * r)) - bRate*hrs;
    if(contrib>0) total += contrib;
  }
  return total;
}
function activeContribs(){
  const now = Date.now();
  const W = Math.max(80, lbs());
  const r = rConst();
  const bRate = beta();
  const arr=[];
  for(const d of DRINKS){
    const A = d.std * STD_FL_OZ;
    const hrs = (now - d.t)/3600000;
    const contrib = (A * 5.14 / (W * r)) - bRate*hrs;
    if(contrib>0) arr.push({b:contrib,t:d.t,rem:contrib/bRate});
  }
  return arr;
}
function etaFrom(contribs, target){
  const bRate = beta();
  if(contribs.length===0) return 0;
  const arr=[...contribs].sort((a,b)=>a.rem-b.rem);
  let total = arr.reduce((s,d)=>s+d.b,0);
  let prev = 0;
  let active = arr.length;
  for(const c of arr){
    const dt = c.rem - prev;
    if(total - bRate*active*dt <= target){
      const needed = total - target;
      return prev + needed/(bRate*active);
    }
    total -= bRate*active*dt;
    prev = c.rem;
    active--;
  }
  return prev;
}
function recalc(){
  const contribs = activeContribs();
  const b = contribs.reduce((s,d)=>s+d.b,0);
    session.peak=Math.max(session.peak||0,b);
    els.bac.textContent=b.toFixed(3);
    els.peak.textContent=session.peak.toFixed(3);
    const totalStd = DRINKS.reduce((s,d)=>s+d.std,0);
    els.stdDrinks.textContent = totalStd.toFixed(2);
  const earliest = contribs.length?Math.min(...contribs.map(d=>d.t)):null;
  els.elapsed.textContent=earliest?fmtHM(Date.now()-earliest):'0:00';
  els.eta50.textContent=b<=0.05?'Now':fmtEta(etaFrom(contribs,0.05));
  els.eta00.textContent=b<=0?'Now':fmtEta(etaFrom(contribs,0));
}

function startClock(){
  stopClock();
  function update(){
    if(!session.started || !session.t0){
      els.sessionClock.textContent='0:00:00';
      return;
    }
    els.sessionClock.textContent = fmtH(Date.now()-session.t0);
  }
  update();
  session.clockTick = setInterval(update, 1000);
}
function stopClock(){ if(session.clockTick) clearInterval(session.clockTick); session.clockTick=null; }
function startRecalc(){ if(session.tick) clearInterval(session.tick); session.tick = setInterval(recalc, 1000); }
function stopRecalc(){ if(session.tick) clearInterval(session.tick); session.tick=null; }

document.querySelectorAll('button.drink').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    if(!session.started){ toast('Start session first'); return; }
    const std=parseFloat(btn.dataset.std), name=btn.dataset.name;
    const icon=btn.textContent.trim().split(' ')[0];
    DRINKS.push({name, std, icon, t: Date.now()});
    saveSession(); recalc(); renderDrinkLog();
    toast(`+ ${name} (${std.toFixed(2)} std)`);
    const emoji=document.createElement('div');
    emoji.className='fun-emoji';
    emoji.textContent=['üçª','ü•Ç','üçπ','üéâ'][Math.floor(Math.random()*4)];
    const r=btn.getBoundingClientRect(), s=els.scene.getBoundingClientRect();
    emoji.style.left=(r.left - s.left + r.width/2)+'px';
    emoji.style.top=(r.top - s.top)+'px';
    els.scene.appendChild(emoji);
    setTimeout(()=>emoji.remove(),1000);
  });
});
els.startBtn.addEventListener('click', ()=>{ if(session.started) return; session.started=true; session.t0=Date.now(); session.peak=0; DRINKS.length=0; renderDrinkLog(); els.sessionState.textContent='Running'; els.endBtn.disabled=false; els.shareBtn.disabled=true; els.startBtn.disabled=true; saveSession(); startClock(); startRecalc(); recalc(); });
els.endBtn.addEventListener('click', async ()=>{
  if(!session.started) return;
  stopClock(); stopRecalc(); session.started=false;
  els.sessionState.textContent='Ended';
  els.endBtn.disabled=true; els.startBtn.disabled=false; els.shareBtn.disabled=false;
  saveSession(); recalc();
  await shareApp();
});
els.shareBtn.addEventListener('click', shareApp);
els.copyLinkBtn.addEventListener('click', async ()=>{
  try{ await navigator.clipboard.writeText(els.shareUrl.value); toast('Link copied!'); }catch{}
});
els.closeShare.addEventListener('click', ()=> els.shareModal.classList.add('hide'));
els.shareModal.addEventListener('click', e=>{ if(e.target===els.shareModal) els.shareModal.classList.add('hide'); });
document.addEventListener('keydown', e=>{ if(e.key==='Escape' && !els.shareModal.classList.contains('hide')) els.shareModal.classList.add('hide'); });
els.uberBtn.addEventListener('click', ()=>{
  const appUrl='uber://';
  const fallbackUrl='https://www.uber.com/us/en/download/';
  const start=Date.now();
  window.location.href=appUrl;
  setTimeout(()=>{
    if(Date.now()-start<1500){ window.location.href=fallbackUrl; }
  },1000);
});
els.sex.addEventListener('change', ()=>{ els.rWrap.style.display=(els.sex.value==='c')?'grid':'none'; storePrefs(); recalc(); });
[els.weight, els.units, els.rval, els.beta].forEach(i=> i.addEventListener('input', ()=>{ storePrefs(); recalc(); }));

restorePrefs(); restoreSession(); recalc(); renderDrinkLog();

}
</script>
<script>
// Modal welcome + install prompt
let deferredPrompt=null;
const modal=document.getElementById('welcomeModal');
const installBtn=document.getElementById('installBtn');
window.addEventListener('load',()=>{
  const installed=localStorage.getItem('pwaInstalled')==='1'||window.matchMedia('(display-mode: standalone)').matches;
  if(!installed){ modal.classList.remove('hide'); }
});
window.addEventListener('beforeinstallprompt',(e)=>{ e.preventDefault(); deferredPrompt=e; installBtn.disabled=false; });
installBtn.addEventListener('click', async ()=>{
  if(!deferredPrompt){ modal.classList.add('hide'); return; }
  deferredPrompt.prompt();
  try{ await deferredPrompt.userChoice; }catch{}
  deferredPrompt=null;
  modal.classList.add('hide');
});
modal.addEventListener('click', (e)=>{ if(e.target===modal) modal.classList.add('hide'); });
window.addEventListener('appinstalled',()=>{ localStorage.setItem('pwaInstalled','1'); });


(async function injectManifestAndIcons(){
  const icon192=await drawIcon(192), icon512=await drawIcon(512);
  const manifest={name:"Bar Buddy ‚Äî BAC Estimator", short_name:"Bar Buddy", start_url:"./", display:"standalone", background_color:"#0b0b0c", theme_color:"#2e2a2a",
    icons:[{src:icon192,sizes:"192x192",type:"image/png",purpose:"any maskable"},{src:icon512,sizes:"512x512",type:"image/png",purpose:"any maskable"}]};
  const blob=new Blob([JSON.stringify(manifest)],{type:'application/manifest+json'});
  const link=document.createElement('link'); link.rel='manifest'; link.href=URL.createObjectURL(blob); document.head.appendChild(link);
  const touch=document.createElement('link'); touch.rel='apple-touch-icon'; touch.href=icon192; document.head.appendChild(touch);
})();
function drawIcon(size){ const c=document.createElement('canvas'); c.width=c.height=size; const ctx=c.getContext('2d'); ctx.fillStyle='#2b2320'; ctx.fillRect(0,0,size,size); ctx.fillStyle='#ffd26b'; ctx.font=`${Math.floor(size*0.6)}px serif`; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText('üç∏', size/2, size/2+size*0.05); return c.toDataURL('image/png'); }

(function registerSW(){ if(!('serviceWorker' in navigator)) return; const swCode=`
  const CACHE='barbuddy-v4';
  const ASSETS=['./','./index.html'];
  self.addEventListener('install',e=>{e.waitUntil(caches.open(CACHE).then(c=>c.addAll(ASSETS))); self.skipWaiting();});
  self.addEventListener('activate',e=>{e.waitUntil(caches.keys().then(keys=>Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k))))); self.clients.claim();});
  self.addEventListener('fetch',e=>{e.respondWith(fetch(e.request).catch(()=>caches.match(e.request).then(r=>r||caches.match('./'))));});
`; const url=URL.createObjectURL(new Blob([swCode],{type:'text/javascript'})); navigator.serviceWorker.register(url).catch(()=>{}); })();
</script>
</body>
</html>
